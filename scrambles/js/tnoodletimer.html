<!DOCTYPE html>
<html>
<head>
<title>ScramblerTest</title>
<meta http-equiv="Content-Type" content="text/html;charset=UTF-8" />

<link type="text/css" rel="stylesheet" href="ScrambleStuff.css" media="screen" />
<link type="text/css" rel="stylesheet" href="wz_dragdrop.css" media="screen" />
<style type="text/css">
html, body {
	font-family: sans-serif;
	height: 100%;
	overflow: hidden;
}
img {
    border: none;
    padding: 1px;
}

.tabs {
/* TODO: this doesn't overflow nicely */
	overflow: auto;
	
	padding: 0 0 0 1em;
	margin: 0 0 0 0;
	list-style:none;
	line-height:1em;
}

.tabs li {
	float:left;
	margin:0;
	padding:0;
	
	cursor: default;
	display:block;
	color:#444;
	text-decoration:none;
	font-weight:bold;
	background:#ddd;
	padding:0.25em;
	border-left:1px solid black;
	border-right:1px solid black;
}

.tabs li .delete {
	margin-left: 1em;
	position: relative;
	right: 0px;
	cursor: pointer;
}

.tabs li .delete:hover {
	background: white;
}
.tabs li:hover, .tabs li.active {
	background: #efefef;
}

#timesArea {
	border: 1px solid;
	padding: 5px;
	overflow: auto;
}


</style>

<script type="text/javascript" src="mootools-1.2.4-core.js"></script>
<script type="text/javascript" src="mootools-1.2.4.4-more.js"></script>
<script type="text/javascript" src="tnoodleserver.js"></script>
<script type="text/javascript" src="tnoodlescrambles.js"></script>
<script type="text/javascript" src="wz_dragdrop.js"></script>
<script type="text/javascript" src="ColorChooser.js"></script>
<script type="text/javascript" src="ScrambleStuff.js"></script>

<script type="text/javascript">
window.addEvent('domready', function() {
	var sessions = new Hash({ "l4erux": { puzzle: "4x4x4", times: [ 65, 70 ] } });
	
	var configuration = new tnoodle.server().configuration;

	function scramblesLoaded() {
		sessionClicked.call($(currSessionId), null);
	}
	var scrambleStuff = new ScrambleStuff(configuration, scramblesLoaded);
	document.getElementById('puzzleChooser').appendChild(scrambleStuff.puzzleSelect);
	document.getElementById('scrambleArea').appendChild(scrambleStuff.scrambleArea);
	
	$('scrambler').addEvent('click', scrambleStuff.scramble);

	
	scrambleStuff.addPuzzleChangeListener(function(newPuzzle) {
		sessions[currSessionId].puzzle = newPuzzle;
	});

	var currSessionId = null;
	function sessionClicked(e) {
		newId = this.get('id');
		// if e == null, then this function wasn't called by the user clicking something,
		// so we go ahead and select the session (this allows for initialization)
		if(e != null && newId === currSessionId)
			return;
		currSessionId = newId;
		var session = sessions[currSessionId];
		
		$$('#sessions .active').each(function(el) {
			el.removeClass('active');
		});
		this.addClass('active');

		var table = new HtmlTable($('timesTable'));
		table.empty();
		session.times.each(function(time) {
			table.push([time]);
		});

		scrambleStuff.setSelectedPuzzle(session.puzzle);
	}
	function closeSession(e) {
		e.stop(); //prevent the tab from activating

		delete sessions[this.sessionId];
		$(this.sessionId).dispose();
		if(this.sessionId == currSessionId) {
			//TODO - create new session?
		}
	}
	function createSessionTab(sessionId) {
		//TODO - puzzle icon
		var newSession = new Element('li', { 'html': sessionId, 'id': sessionId });
		newSession.addEvent('click', sessionClicked);

		var close = new Element('span', { 'html': 'X', 'class': 'delete' });
		close.sessionId = sessionId;
		close.inject(newSession, 'bottom'); 
		close.addEvent('click', closeSession);
		return newSession;
	}
	
	$('newSession').addEvent('click', function(e) {
		//sessionId is the number of seconds since the epoch encoded in base 36 for readability
		var sessionId = Math.round(new Date().getTime()/1000).toString(36);
		if(sessionId in sessions) //we don't want duplicate session ids
			return;

		//TODO - use default puzzle for session? if so, how does the user set the default puzzle?
		sessions.set(sessionId, {puzzle: scrambleStuff.getSelectedPuzzle(), times: []});
		var sessionTab = createSessionTab(sessionId);
		sessionTab.inject($('newSession'), 'before');
		sessionClicked.call(sessionTab, null);
	});

	//TODO - do something if sessions is empty!
	sessions.getKeys().sort().each(function(sessionId, index, ids) {
		var sessionTab = createSessionTab(sessionId);
		sessionTab.inject($('newSession'), 'before');
		if(index == ids.length - 1) {
			//we set the current session to the most recent session
			currSessionId = sessionId;
		}
	});
	
	function resizeTimesArea() {
		setTimeout(function() { //wait for laying-out to occur
			var remainingHeight = window.getSize().y-$('chrome').getSize().y;
			remainingHeight -= 30; //TODO - what the heck is this all about?
			$('timesArea').setStyle('height', remainingHeight);
		}, 100); // 100 seems to work here ... man this feels hacky
	};
	window.addEvent('load', resizeTimesArea);
	scrambleStuff.addScrambleChangeListener(resizeTimesArea);

	window.addEvent('resize', resizeTimesArea); //TODO - ensure that draggable windows (scramble) are visible
});

</script>
</head>
<body>

<div id="chrome">
<span id="puzzleChooser"></span>
<input id="scrambler" type="button" value="Next scramble"></input>

<div id="scrambleArea"></div>

<ul id="sessions" class="tabs">
	<li id="newSession">+</li>
</ul>
</div>

<div id="timesArea">
<table id="timesTable"></table>
</div>

</body>
</html>
