<!DOCTYPE html>
<html>
<head>
<title>TNoodleTimer</title>
<meta http-equiv="Content-Type" content="text/html;charset=UTF-8" />

<link type="text/css" rel="stylesheet" href="ScrambleStuff.css" media="screen" />
<link type="text/css" rel="stylesheet" href="wz_dragdrop.css" media="screen" />
<style type="text/css">
html, body {
	font-family: sans-serif;
}
body {
	margin: 0px 8px 8px 8px;
}
img {
    border: none;
    padding: 1px;
}

.importDiv {
	right: 0px;
}

#chrome {
	margin-bottom: 10px;
}
#resizeTimer, #horizontalRuler, #verticalRuler {
	z-index: 1;
}
#horizontalRuler, #verticalRuler {
	position: absolute;
	background-color: black;
}
.resize-br {
    background: none repeat scroll 0 0 #FFF;
    border: 1px solid #333;
    font-size: 1px;
    position: absolute;
    width: 5px;
    height: 5px;

    cursor: se-resize;
}
#topLeft {
	position: absolute;
	left: 0px;
	
	text-align: center;
}
#topRight {
	position: absolute;
	right: 8px;
}
.scrambleText {
	overflow: auto;
}

/*** This is for KeyboardTimer.js***/
@font-face {  
	font-family: lcd;
	src: url("Digiface Regular.eot");
	src: 	local('Digiface Regular'), 
			url("Digiface Regular.ttf") format("truetype");  
}
#timer, #sizer {
	font-family: lcd;
	position: relative;  
}
/*** End KeyboardTimer.js ***/

.tabs {
/* TODO: this doesn't overflow nicely */
	overflow: auto;
	
	/* This lets our tabs overflow the border below */
	position: relative;
	top: 1px;
	
	padding: 0 0 0 1em;
	margin: 0 0 0 0;
	list-style:none;
	line-height:1em;
}

.tabs li {
	float:left;
	margin:0;
	padding:0;
	
	cursor: default;
	display:block;
	color:#444;
	text-decoration:none;
	font-weight:bold;
	background:#aaa;
	padding:0.25em;
	border:1px solid black;
}

.tabs li .delete {
	margin-left: 1em;
	position: relative;
	right: 0px;
	cursor: pointer;
}

.tabs li .delete:hover {
	background: white;
}
.tabs li.active {
	border-bottom: 1px solid #efefef;
}
.tabs li:hover, .tabs li.active, #sessionInfo {
	background: #efefef;
}

#sessionInfo {
	padding: 5px;
}

#timesArea {
	border: 1px solid;
}

#timesTable {
	margin: 5px;
	/*border-style: hidden;*/
	border-collapse: collapse;
}
#timesTable thead tr, #timesTable tfoot tr {
	display: block;
}
#timesTable tbody {
	overflow: auto;
	display: block;
}
#timesTable th {
	cursor: pointer;
}
#timesTable .table-th-sort-span {
	display: inline-block;
	width: 16px;
	height: 16px;
}
#timesTable .table-th-sort .table-th-sort-span {
	background: transparent url('bullet_arrow_up.png') 0px 0px no-repeat;
}

#timesTable .table-th-sort-rev .table-th-sort-span {
	background: transparent url('bullet_arrow_down.png') 0px 0px no-repeat;
	width: 16px;
	height: 16px;
}

#timesTable td, #timesTable th {
	border: 1px solid;
	padding: 1px 2px 1px 2px;
	border-style: inset;
}

#timesTable tr:nth-child(even) {background: #CCC}
#timesTable tr:nth-child(odd) {background: #FFF}

</style>

<script type="text/javascript" src="mootools-1.2.4-core.js"></script>
<script type="text/javascript" src="mootools-1.2.4.4-more.js"></script>
<script type="text/javascript" src="tnoodleserver.js"></script>
<script type="text/javascript" src="tnoodlescrambles.js"></script>
<script type="text/javascript" src="wz_dragdrop.js"></script>
<script type="text/javascript" src="ColorChooser.js"></script>
<script type="text/javascript" src="ScrambleStuff.js"></script>
<script type="text/javascript" src="KeyboardTimer.js"></script>
<script type="text/javascript" src="TimesTable.js"></script>

<script type="text/javascript">
window.addEvent('domready', function() {
	var server = new tnoodle.server();
	var configuration = server.configuration;
	
	var timer = new KeyboardTimer($('topLeft'));

	//we have to wait for both the scrambles and the sessions to load,
	//and we can't know which will load first, so we use lastSessionTab and scramblesLoades
	//to keep track
	var lastSessionTab = null;
	var scramblesLoaded = false;
	function onScramblesLoaded() {
		scramblesLoaded = true;
		if(lastSessionTab)
			sessionClicked.call(lastSessionTab, null);
	}
	var scrambleStuff = new ScrambleStuff(configuration, onScramblesLoaded);
	document.getElementById('puzzleChooser').appendChild(scrambleStuff.puzzleSelect);
	document.getElementById('scrambleArea').appendChild(scrambleStuff.scrambleArea);
	
	scrambleStuff.addPuzzleChangeListener(function(newPuzzle) {
		session.puzzle = newPuzzle;
	});

	function refreshSessionInfo() {
		if(!session) return; //gotta wait for stuff to load
		
		$('sessionInfo').empty();
		$('sessionInfo').appendText(session.puzzle + " session ");
		//$('sessionInfo').appendText(session.id + " ");
		var date = new Date(1000*parseInt(session.id, 36));
		var today = new Date();
		var i, ago;
		var resolutions = [ 'year', 'month', 'day', 'hour', 'minute' ];
		for(i = 0; i < resolutions.length; i++) {
			ago = date.diff(today, resolutions[i]);
			a = date; b = today;
			if(ago > 0)
				break;
		}
		var ago = (i < resolutions.length) ? 
				ago + " " + resolutions[i] + "(s)" :
				"seconds";
		$('sessionInfo').appendText("started " + ago + " ago");
	}
	
	var session = null;
	var timesTable = new TimesTable($('timesTable'), configuration);
	timer.addEvent('newTime', function(timeCentis) {
		timesTable.addTime(timeCentis);
		scrambleStuff.scramble();
	});
	function sessionClicked(e) {
		lastSessionTab = this;
		var newSession = this.session;
		if(newSession === session)
			return;
		session = newSession;
		$$('#sessions .active').each(function(el) {
			el.removeClass('active');
		});
		this.addClass('active');

		timesTable.setSession(session);
		refreshSessionInfo();
		scrambleStuff.setSelectedPuzzle(session.puzzle);
	}
	function closeSession(e) {
		e.stop(); //prevent the tab from activating
		var deletedSession = this.session;
		
		var newTab = lastSessionTab.nextSibling; //try the tab to the right
		if(!newTab.session) {
			newTab = lastSessionTab.previousSibling; //try the tab to the left
			if(!newTab.session) {
				//TODO - create new session? for now, we just don't allow it
				return;
			}
		}

		server.disposeSession(deletedSession);
		this.tab.dispose();
		if(deletedSession == session) {
			//deleting the current session, so we select the next one to the left
			sessionClicked.call(newTab);			
		}
	}
	function createSessionTab(session) {
		//TODO - puzzle icon
		var tab = new Element('li', { 'html': session.id });
		tab.addEvent('click', sessionClicked);
		tab.session = session;

		var close = new Element('span', { 'html': 'X', 'class': 'delete' });
		close.session = session;
		close.tab = tab;
		close.inject(tab, 'bottom'); 
		close.addEvent('click', closeSession);
		return tab;
	}
	
	$('newSession').addEvent('click', function(e) {
		var session = server.createSession(scrambleStuff.getSelectedPuzzle());
		if(!session) //couldn't create session, for whatever reason
			return;

		var tab = createSessionTab(session);
		tab.inject($('newSession'), 'before');
		sessionClicked.call(tab, null);
	});

	//TODO - do something if sessions is empty!
	server.sessions.each(function(sesh, index, ids) {
		var sessionTab = createSessionTab(sesh);
		sessionTab.inject($('newSession'), 'before');
		if(index == ids.length - 1) {
			//we set the current session to the most recent session
			lastSessionTab = sessionTab;
			if(scramblesLoaded)
				sessionClicked.call(lastSessionTab);
		}
	});

	var isResizing = false;
	function resizeTimesArea() {
		//ie seems to be firing the resize event due to some of the actions
		//that occur inside of this function, so we place a lock around it
		if(isResizing)
			return;
		isResizing = true;
		setTimeout(function() { //wait for laying-out to occur
			//TODO - I DO NOT believe that this can't be done with css!!!
			//TODO - hide everything until the first resize occurs?
			
			var viewSize = window.getSize();
			var topLeftSize = $('topLeft').getSize();
			var h = topLeftSize.y;

			timer.redraw();
			$('chrome').setStyle('height', h);

			$('topRight').setStyle('height', h);
			var newH = Math.max(0, viewSize.x-topLeftSize.x-$('topRight').getStyle('right').toInt());
			$('topRight').setStyle('width', newH);
			
			h -= $('scrambleBorder').getSize().y;
			$$('.scrambleArea')[0].setStyle('height', h);
			h -= $$('.scrambleHeader')[0].getSize().y;
			var scrambleText = $$('.scrambleText')[0];
			var padding = scrambleText.getStyle('padding-top').toInt() + scrambleText.getStyle('padding-top').toInt();
			$$('.scrambleText')[0].setStyle('height', h-padding);
			
			var remainingHeight = viewSize.y-$('chrome').getSize().y;
			remainingHeight -= 50; //TODO - what the heck is this all about?
			if(remainingHeight < 0) //ie freaks out if we try to set negative sizes
				remainingHeight = 0;
			$('timesArea').setStyle('height', remainingHeight);

			remainingHeight -= $('sessionInfo').getSize().y;
			timesTable.resize();

			//this just seems like as good a time as any to update the session info bar
			refreshSessionInfo();
			
			isResizing = false;
		}, 100); // 100 seems to work here ... man this feels hacky
	};
	window.addEvent('load', resizeTimesArea);
	//scrambleStuff.addScrambleChangeListener(resizeTimesArea); //new scrambles no longer resize the window

	window.addEvent('resize', resizeTimesArea); //TODO - ensure that draggable windows (scramble) are visible

	//setting size of the timer
	var width = configuration.get('timer.width', 350);
	var height = configuration.get('timer.height', 200);
	$('topLeft').setStyle('width', width);
	$('topLeft').setStyle('height', height);
	$('resizeTimer').setPosition({x: width-5-1, y: height-5});
	
	var dragger = new Drag($('resizeTimer'));
	dragger.addEvent('complete', function(el, e) {
		var pos = el.getPosition();
		var size = el.getSize();
		var offset = $('topLeft').getPosition();
		var newWidth = pos.x + size.x - offset.x - 1;
		var newHeight = pos.y + size.y - offset.y - 2;
		$('topLeft').setStyle('width', newWidth);
		$('topLeft').setStyle('height', newHeight);
		configuration.set('timer.width', newWidth);
		configuration.set('timer.height', newHeight);
		resizeTimesArea();
	});
	function positionRulers() {
		//there's a lot of pixel pushing here, oh well
		var loc = $('resizeTimer').getPosition();
		var width = window.getSize().x;
		$('horizontalRuler').setStyle('width', width);
		$('horizontalRuler').setStyle('height', 3);
		$('horizontalRuler').setPosition({x: 0, y: loc.y+2});
		
		$('verticalRuler').setStyle('width', 3);
		$('verticalRuler').setStyle('height', loc.y);
		$('verticalRuler').setPosition({x: loc.x+2, y: 0});
	}
	//should this be on start, on drag, or beforeStart?
	dragger.addEvent('beforeStart', function(el) {
		$('horizontalRuler').fade('in');
		$('verticalRuler').fade('in');
		positionRulers();
	});
	dragger.addEvent('drag', positionRulers);
	function doneDragging() {
		$('horizontalRuler').fade('out');
		$('verticalRuler').fade('out');
	}
	dragger.addEvent('cancel', doneDragging);
	dragger.addEvent('complete', doneDragging);
	
	new Keyboard().addShortcut('save', {
	    'keys': 'ctrl+s',
	    'description': 'Save the current document',
	    'handler': function(e) { e.stop(); console.log(this); }
	});
});

</script>
</head>
<body>
<div id="chrome">
	<div id="topLeft">
		<div id="horizontalRuler"></div>
		<div id="verticalRuler"></div>
		<div id="resizeTimer" class="resize-br"></div>
	</div>
	<div id="topRight">
		<div id="scrambleBorder">
			<span id="puzzleChooser"></span>
		</div>
		
		<div id="scrambleArea"></div>
	</div>
</div>

<ul id="sessions" class="tabs">
	<li id="newSession">+</li>
</ul>
<div id="timesArea">
	<div id="sessionInfo"></div>
	<table id="timesTable"></table>
</div>

</body>
</html>
