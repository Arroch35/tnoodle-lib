<!DOCTYPE html>
<html>
<head>
<title>TNoodleTimer</title>
<meta http-equiv="Content-Type" content="text/html;charset=UTF-8" />

<link type="text/css" rel="stylesheet" href="css/wz_dragdrop.css" media="screen" />
<link type="text/css" rel="stylesheet" href="css/ScrambleStuff.css" media="screen" />
<link type="text/css" rel="stylesheet" href="css/KeyboardTimer.css" media="screen" />
<link type="text/css" rel="stylesheet" href="css/TimesTable.css" media="screen" />

<script type="text/javascript" src="js/mootools-1.2.4-core.js"></script>
<script type="text/javascript" src="js/mootools-1.2.4.4-more.js"></script>
<script type="text/javascript" src="js/tnoodleserver.js"></script>
<script type="text/javascript" src="js/tnoodlescrambles.js"></script>
<script type="text/javascript" src="js/wz_dragdrop.js"></script>
<script type="text/javascript" src="js/ColorChooser.js"></script>
<script type="text/javascript" src="js/ScrambleStuff.js"></script>
<script type="text/javascript" src="js/KeyboardTimer.js"></script>
<script type="text/javascript" src="js/TimesTable.js"></script>
<script type="text/javascript" src="js/StackApplet.js"></script>


<style type="text/css">
html, body {
	font-family: sans-serif;
	overflow: hidden;
}
body {
	margin: 0px 8px 8px 8px;
}
img {
    border: none;
    padding: 1px;
}

span.link {
	white-space: nowrap;
	color: brown;
	text-decoration: underline;
	cursor: pointer;
	padding-left: 10px;
}
span.link:hover, span.down {
	text-decoration: none;
	color: red;
}

.importDiv {
	z-index: 2; /*on top of scramble window */
}

#chrome {
	margin-bottom: 10px;
}
#resizeTimer, #horizontalRuler, #verticalRuler {
	z-index: 1;
}
#horizontalRuler, #verticalRuler {
	position: absolute;
	background-color: black;
}
.resize-br {
    background: none repeat scroll 0 0 #FFF;
    border: 1px solid #333;
    font-size: 1px;
    position: absolute;
    width: 5px;
    height: 5px;

    cursor: se-resize;
}
#topLeft {
	position: absolute;
	left: 0px;
	
	text-align: center;
}
#topRight {
	position: absolute;
	right: 8px;
}
.scrambleText {
	overflow: auto;
}

.tabs {
/* TODO: this doesn't overflow nicely */
	overflow: auto;
	
	/* This lets our tabs overflow the border below */
	position: relative;
	top: 1px;
	
	padding: 0 0 0 1em;
	margin: 0 0 0 0;
	list-style:none;
	line-height:1em;
}

.tabs li {
	float:left;
	margin:0;
	padding:0;
	
	cursor: default;
	display:block;
	color:#444;
	text-decoration:none;
	font-weight:bold;
	background:#aaa;
	padding:0.25em;
	border:1px solid black;
}

.tabs li .delete {
	margin-left: 1em;
	position: relative;
	right: 0px;
	cursor: pointer;
}

.tabs li .delete:hover {
	background: white;
}
.tabs li.active {
	border-bottom: 1px solid #efefef;
}
.tabs li:hover, .tabs li.active, #sessionInfoBar {
	background: #efefef;
}

#sessionInfoBar {
	padding: 5px;
}

#timesArea {
	border: 1px solid;
}
</style>

<script type="text/javascript">
window.addEvent('domready', function() {
	var server = new tnoodle.server();
	var configuration = server.configuration;
	
	var timer = new KeyboardTimer($('topLeft'), server);

	//we have to wait for both the scrambles and the sessions to load,
	//and we can't know which will load first, so we use lastSessionTab and scramblesLoades
	//to keep track
	var lastSessionTab = null;
	var scramblesLoaded = false;
	function onPuzzlesLoaded(puzzles) {
		scramblesLoaded = true;
		if(session)
			scrambleStuff.setSelectedPuzzle(session.getPuzzle());
	}
	var scrambleStuff = new ScrambleStuff(configuration, onPuzzlesLoaded);
	document.getElementById('puzzleChooser').appendChild(scrambleStuff.puzzleSelect);
	document.getElementById('scrambleArea').appendChild(scrambleStuff.scrambleArea);
	
	var customizationSelect = new Element('select');
	customizationSelect.refresh = function() {
		var customizations = server.getCustomizations(session.getPuzzle());
		customizationSelect.options.length = customizations.length;
		for(var i = 0; i < customizations.length; i++)
			customizationSelect.options[i] = new Option(customizations[i], customizations[i]);

		customizationSelect.value = session.getCustomization();
	};
	$('puzzleChooser').adopt(customizationSelect);

	var editCustomization = new Element('span', { 'class': 'link', 'html': 'Add customization' });
	editCustomization.addEvent('click', function(e) {
		//TODO - provide a better gui for this
		var newCustomization = prompt("Enter name of new customization (this will become a pretty gui someday, I promise!)");
		if(newCustomization) {
			server.createCustomization(session.getPuzzle(), newCustomization);
			customizationSelect.refresh();
		}
	});
	$('puzzleChooser').adopt(editCustomization);

	customizationSelect.onchange = function(e) {
		session.setCustomization(customizationSelect.value);
		refreshSessionInfo();
	}; //for some reason, the change event doesn't fire until the select loses focus
	scrambleStuff.addPuzzleChangeListener(function(newPuzzle) {
		if(session.getPuzzle() == newPuzzle)
			return;
		
		session.setPuzzle(newPuzzle);
		customizationSelect.refresh();
		session.setCustomization(customizationSelect.value);
		refreshSessionInfo();
	});

	//we try to be clever and change the href only after the anchor has been clicked
	//this should save us a the bother of generating the csv over and over again
	//TODO - this is probably getting called twice when clicking, due to the mousedown event, and then the click event
	function downloadCSV() {
		//TODO - a mapping of keys to descriptions/tooltips would clean up a this + lot of code in TimesTable.js
		//TODO - comments?
		var keys = [ 'index', null, 'mean3', 'ra5', 'ra12', 'ave100', 'sessionAve', 'tags', 'date', 'scramble' ];
		var isTime = [ false, true, true, true, true, true, true, false, false, false ];
		var data = ',Time,Mean 3,Ra 5,Ra12,Ave 100,Session Ave,Tags,Date,Scramble\n';
		
		var times = session.times;
		for(var i = 0; i < session.times.length; i++) {
			var time = session.times[i];
			for(var j = 0; j < keys.length; j++) {
				var key = keys[j];
				var val = key ? time[key] : time.getValueCentis();
				if(isTime[j])
					val = server.formatTime(val);
				//we surround each value with double quotes and escape each double quote, just to be safe
				val = val == null ?
						'' :
						'"' + val.toString().replace(/"/g, '""') + '"';
				data += val + ',';
			}
			data += "\n";
		}
		var uri = 'data:text/csv;charset=utf8,' + encodeURIComponent(data);
		this.href = uri;
	}
	function resetSession() {
		if(confirm("Are you sure you want to reset the session?"))
			timesTable.reset();
	}
	function refreshSessionInfo() {
		if(!session) return; //gotta wait for stuff to load
		$('sessionInfo').empty();
		$('sessionInfo').appendText(session.getPuzzle());
		if(session.getCustomization().length > 0) {
			$('sessionInfo').appendText(" " + session.getCustomization());
		}
		$('sessionInfo').appendText(" session ");
		//$('sessionInfo').appendText(session.id + " ");
		var date = new Date(1000*parseInt(session.id, 36));
		var today = new Date();
		var i, ago;
		var resolutions = [ 'year', 'month', 'day', 'hour', 'minute' ];
		for(i = 0; i < resolutions.length; i++) {
			ago = date.diff(today, resolutions[i]);
			a = date; b = today;
			if(ago > 0)
				break;
		}
		var ago = (i < resolutions.length) ? 
				ago + " " + resolutions[i] + "(s)" :
				"seconds";
		$('sessionInfo').appendText("started " + ago + " ago");
	}
	
	var session = null;
	var timesTable = new TimesTable($('timesTable'), server, scrambleStuff);
	timer.addEvent('newTime', function(timeCentis) {
		timesTable.addTime(timeCentis);
	});
	function sessionClicked(e) {
		lastSessionTab = this;
		var newSession = this.session;
		if(newSession === session)
			return;
		session = newSession;
		$$('#sessions .active').each(function(el) {
			el.removeClass('active');
		});
		this.addClass('active');

		refreshSessionInfo();
		timesTable.setSession(session);
		scrambleStuff.setSelectedPuzzle(session.getPuzzle());
		customizationSelect.refresh();
	}
	function closeSession(e) {
		e.stop(); //prevent the tab from activating
		var deletedSession = this.session;
		
		var newTab = lastSessionTab.nextSibling; //try the tab to the right
		if(!newTab.session) {
			newTab = lastSessionTab.previousSibling; //try the tab to the left
			if(!newTab.session) {
				if(confirm("You can't delete the last session! If you click ok, I will reset it.")) {
					timesTable.reset();
				}
				return;
			}
		}
		if(deletedSession.times.length > 0 && !confirm("Are you sure you want to delete session " + deletedSession.id + "?"))
			return;
		server.disposeSession(deletedSession);
		this.tab.dispose();
		if(deletedSession == session) {
			//deleting the current session, so we select the next one to the left
			sessionClicked.call(newTab);			
		}
	}
	function createSessionTab(session) {
		//TODO - puzzle icon
		var tab = new Element('li', { 'html': session.id });
		tab.addEvent('click', sessionClicked);
		tab.session = session;

		var close = new Element('span', { 'html': 'X', 'class': 'delete' });
		close.session = session;
		close.tab = tab;
		close.inject(tab, 'bottom'); 
		close.addEvent('click', closeSession);
		return tab;
	}
	
	$('newSession').addEvent('click', function(e) {
		var newSession = server.createSession(session.getPuzzle(), session.getCustomization());
		if(!newSession) //couldn't create session, for whatever reason
			return;

		var tab = createSessionTab(newSession);
		tab.inject($('newSession'), 'before');
		sessionClicked.call(tab, null);
	});
	
	$('resetSession').addEvent('click', resetSession);
	$('downloadCSV').addEvent('click', downloadCSV);
	$('downloadCSV').addEvent('mousedown', downloadCSV);

	//TODO - do something if sessions is empty!
	server.sessions.each(function(sesh, index, ids) {
		var sessionTab = createSessionTab(sesh);
		sessionTab.inject($('newSession'), 'before');
		if(index == ids.length - 1) {
			//we set the current session to the most recent session
			lastSessionTab = sessionTab;
			sessionClicked.call(lastSessionTab);
		}
	});

	var isResizing = false;
	function resizeTimesArea(dontScroll) {
		//ie seems to be firing the resize event due to some of the actions
		//that occur inside of this function, so we place a lock around it
		if(isResizing)
			return;
		isResizing = true;
		
		//TODO - I DO NOT believe that this can't be done with css!!!
		//TODO - hide everything until the first resize occurs?
		//TODO - this is getting called way too freaking much, firefox is dying everytime you add a new time
		
		var viewSize = window.getSize();
		var topLeftSize = $('topLeft').getSize();
		var h = topLeftSize.y;

		timer.redraw();
		$('chrome').setStyle('height', h);

		$('topRight').setStyle('height', h);
		var newH = Math.max(0, viewSize.x-topLeftSize.x-$('topRight').getStyle('right').toInt());
		$('topRight').setStyle('width', newH);
		
		h -= $('scrambleBorder').getSize().y;
		$$('.scrambleArea')[0].setStyle('height', h);
		h -= $$('.scrambleHeader')[0].getSize().y;
		var scrambleText = $$('.scrambleText')[0];
		var padding = scrambleText.getStyle('padding-top').toInt() + scrambleText.getStyle('padding-top').toInt();
		$$('.scrambleText')[0].setStyle('height', h-padding);
		
		var remainingHeight = viewSize.y-$('chrome').getSize().y;
		remainingHeight -= 50; //TODO - what the heck is this all about?
		if(remainingHeight < 0) //ie freaks out if we try to set negative sizes
			remainingHeight = 0;
		$('timesArea').setStyle('height', remainingHeight);

		remainingHeight -= $('sessionInfo').getSize().y;
		timesTable.resize(!dontScroll);

		//this just seems like as good a time as any to update the session info bar
		refreshSessionInfo();
		
		isResizing = false;
	}
	function delayedResize() {
		setTimeout(resizeTimesArea, 100); // 100 seems to work here, man this feels hacky
	}
	window.addEvent('load', resizeTimesArea);

	window.addEvent('focus', function(e) {
		resizeTimesArea(true); //this seems to be helping with some resizing issues i've been having
	});
	//window.addEvent('blur', function(e) {});
	window.addEvent('resize', delayedResize); //TODO - ensure that draggable windows (scramble) are visible

	//setting size of the timer
	var width = configuration.get('timer.width', 350);
	var height = configuration.get('timer.height', 200);
	$('topLeft').setStyle('width', width);
	$('topLeft').setStyle('height', height);
	$('resizeTimer').setPosition({x: width-5-1, y: height-5});
	
	var dragger = new Drag($('resizeTimer'));
	dragger.addEvent('complete', function(el, e) {
		var pos = el.getPosition();
		var size = el.getSize();
		var offset = $('topLeft').getPosition();
		var newWidth = pos.x + size.x - offset.x - 1;
		var newHeight = pos.y + size.y - offset.y - 2;
		$('topLeft').setStyle('width', newWidth);
		$('topLeft').setStyle('height', newHeight);
		configuration.set('timer.width', newWidth);
		configuration.set('timer.height', newHeight);
		resizeTimesArea();
	});
	function positionRulers() {
		//there's a lot of pixel pushing here, oh well
		var loc = $('resizeTimer').getPosition();
		var width = window.getSize().x;
		$('horizontalRuler').setStyle('width', width);
		$('horizontalRuler').setStyle('height', 3);
		$('horizontalRuler').setPosition({x: 0, y: loc.y+4});
		
		$('verticalRuler').setStyle('width', 3);
		$('verticalRuler').setStyle('height', loc.y);
		$('verticalRuler').setPosition({x: loc.x+2, y: 0});
	}
	//should this be on start, on drag, or beforeStart?
	dragger.addEvent('beforeStart', function(el) {
		$('horizontalRuler').fade('in');
		$('verticalRuler').fade('in');
		positionRulers();
	});
	dragger.addEvent('drag', positionRulers);
	function doneDragging() {
		$('horizontalRuler').fade('out');
		$('verticalRuler').fade('out');
	}
	dragger.addEvent('cancel', doneDragging);
	dragger.addEvent('complete', doneDragging);
	
	var keyboard = new Keyboard();
	keyboard.addShortcut('save', {
	    'keys': 'ctrl+s',
	    'description': 'Save the current document',
	    'handler': function(e) { e.stop(); console.log(this); }
	});
	keyboard.addShortcut('add time', {
		'keys': 'alt+a',
		'description': 'Add time',
		'handler': function(e) { e.stop(); timesTable.promptTime(); }
	});
	keyboard.addShortcut('reset', {
		'keys': 'alt+r',
		'description': 'Reset session',
		'handler': resetSession
	});
});

</script>
</head>
<body>
<div id="chrome">
	<div id="topLeft">
		<div id="horizontalRuler"></div>
		<div id="verticalRuler"></div>
		<div id="resizeTimer" class="resize-br"></div>
	</div>
	<div id="topRight">
		<div id="scrambleBorder">
			<span id="puzzleChooser"></span>
		</div>
		
		<div id="scrambleArea"></div>
	</div>
</div>

<ul id="sessions" class="tabs">
	<li id="newSession">+</li>
</ul>
<div id="timesArea">
	<div id="sessionInfoBar">
		<span id="sessionInfo"></span>
		<span id="resetSession" class="link">Reset</span>
		<a id="downloadCSV" class="link" href="" target="_blank" title="In Chrome, you have to right click and select save as to download. Don't forget to specify a .csv extension!">Download CSV</a>
	</div>
	<table id="timesTable"></table>
</div>
</body>
</html>
